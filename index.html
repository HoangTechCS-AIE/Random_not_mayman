<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title></title>
  <style>
    :root{
      --bg: #0b0d12;
      --bg-elev: #131722;
      --text: #e9eef6;
      --muted: #a7b0c0;
      --accent: #6aa0ff;
      --accent-2: #8bd2a7;
      --danger: #ff7a7a;
      --border: #222838;
      --ring: #7aa2ff66;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f9fc; --bg-elev: #ffffff; --text: #101828; --muted:#667085;
        --accent:#2f6feb; --accent-2:#1aa36f; --danger:#d92d20; --border:#e4e7ec; --ring:#2f6feb40;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{background:var(--bg-elev);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab-btn[aria-selected="true"]{outline:2px solid var(--ring); background:linear-gradient(180deg,var(--bg-elev),#0f1220);
      box-shadow:0 1px 0 #00000020 inset}
    .grid{display:grid;gap:16px}
    .two-col{grid-template-columns:1.1fr 1fr}
    @media (max-width:900px){.two-col{grid-template-columns:1fr}}
    .card{background:var(--bg-elev);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="number"],input[type="text"],textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
    textarea{min-height:140px;resize:vertical}
    .btn{appearance:none;border:1px solid var(--border);background:var(--bg);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:white}
    .btn.ghost{background:transparent}
    .btn.success{background:var(--accent-2);color:white;border-color:transparent}
    .btn.danger{background:var(--danger);color:white;border-color:transparent}
    .btn:focus{outline:3px solid var(--ring)}
    .hint{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .result-banner{font-size:48px;font-weight:800;text-align:center;margin:0}
    .history{max-height:180px;overflow:auto;border:1px dashed var(--border);border-radius:12px;padding:8px}
    .warn{color:var(--danger); font-weight:600}
    .sr-only{position:absolute !important; height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px)}

    /* Wheel */
    .wheel-wrap{position:relative;display:grid;place-items:center;aspect-ratio:1/1;width:min(520px, 90vw);margin:0 auto}
    .pointer{position:absolute;top:-10px;left:50%;transform:translateX(-50%); width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid var(--accent)}
    .wheel-svg{width:100%;height:100%}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}
    th{position:sticky;top:0;background:var(--bg-elev);z-index:1}
    .sticky-tools{position:sticky;top:8px;z-index:3}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üé° V√≤ng quay KhongMayMan </h1>
      <nav class="tabs" role="tablist" aria-label="Ch·ªçn ch·ª©c nƒÉng">
        <button class="tab-btn" role="tab" id="tab-wheel" aria-selected="true" aria-controls="panel-wheel">V√≤ng quay s·ªë</button>
        <button class="tab-btn" role="tab" id="tab-assign" aria-selected="false" aria-controls="panel-assign">Chia ch·ªß ƒë·ªÅ cho nh√≥m</button>
      </nav>
    </header>

    <!-- Panel: Wheel -->
    <section id="panel-wheel" role="tabpanel" aria-labelledby="tab-wheel">
      <div class="grid two-col">
        <div class="card" aria-labelledby="wheel-title">
          <h2 id="wheel-title" style="margin-top:0">Thi·∫øt l·∫≠p v√≤ng quay</h2>
          <div class="row">
            <div style="flex:1; min-width:140px">
              <label for="startNum">S·ªë b·∫Øt ƒë·∫ßu</label>
              <input id="startNum" type="number" inputmode="numeric" value="1" aria-label="S·ªë b·∫Øt ƒë·∫ßu" />
            </div>
            <div style="flex:1; min-width:140px">
              <label for="endNum">S·ªë k·∫øt th√∫c</label>
              <input id="endNum" type="number" inputmode="numeric" value="12" aria-label="S·ªë k·∫øt th√∫c" />
            </div>
            <div>
              <button class="btn" id="buildWheelBtn" aria-label="T·∫°o v√≤ng">T·∫°o v√≤ng</button>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <label class="hint"><input type="checkbox" id="noRepeatChk"> Kh√¥ng l·∫∑p (lo·∫°i s·ªë ƒë√£ tr√∫ng ·ªü l∆∞·ª£t sau)</label>
            <span class="hint" id="wheelHint"></span>
          </div>
          <div class="wheel-wrap" aria-live="polite">
            <div class="pointer" aria-hidden="true"></div>
            <svg class="wheel-svg" id="wheelSvg" viewBox="0 0 500 500" role="img" aria-label="V√≤ng quay s·ªë">
              <!-- dynamic -->
            </svg>
          </div>
          <div class="row" style="justify-content:center; margin-top:12px">
            <button class="btn primary" id="spinBtn" aria-label="B·∫Øt ƒë·∫ßu quay">Start</button>
            <button class="btn ghost" id="copyLastBtn" aria-label="Copy k·∫øt qu·∫£ g·∫ßn nh·∫•t">Copy k·∫øt qu·∫£</button>
            <button class="btn" id="resetWheelBtn" aria-label="Reset v√≤ng quay">Reset</button>
          </div>
        </div>
        <div class="card">
          <div class="sticky-tools">
            <h2 style="margin:0 0 8px">K·∫øt qu·∫£</h2>
          </div>
          <p id="lastResult" class="result-banner" aria-live="polite">‚Äì</p>
          <h3 style="margin:16px 0 8px">L·ªãch s·ª≠</h3>
          <ol id="historyList" class="history" aria-live="polite"></ol>
        </div>
      </div>
    </section>

    <!-- Panel: Assign topics -->
    <section id="panel-assign" role="tabpanel" aria-labelledby="tab-assign" hidden>
      <div class="grid two-col">
        <div class="card">
          <h2 style="margin-top:0">Thi·∫øt l·∫≠p chia ch·ªß ƒë·ªÅ</h2>
          <div class="row">
            <div style="flex:1; min-width:160px">
              <label for="groupCount">S·ªë nh√≥m</label>
              <input id="groupCount" type="number" min="1" value="5" aria-label="S·ªë nh√≥m">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <label><input type="radio" name="topicMode" value="textarea" checked> Nh·∫≠p danh s√°ch ch·ªß ƒë·ªÅ (m·ªói d√≤ng m·ªôt ch·ªß ƒë·ªÅ)</label>
            <label><input type="radio" name="topicMode" value="count"> Nh·∫≠p s·ªë l∆∞·ª£ng ƒë·ªÅ t√†i</label>
          </div>

          <div id="topicsTextareaWrap" style="margin-top:8px">
            <label for="topicsTextarea">Danh s√°ch ch·ªß ƒë·ªÅ</label>
            <textarea id="topicsTextarea" placeholder="V√≠ d·ª•:\nHiHi\nHeHe\nHuHu\nHaHa\nHaHaHuHuHiHiHeHe"></textarea>
            <div class="hint">D√≤ng r·ªóng s·∫Ω b·ªã b·ªè qua. Ch·ªß ƒë·ªÅ tr√πng s·∫Ω t·ª± lo·∫°i tr·ª´ (tr√°nh nh·∫≠p l·ªói).</div>
          </div>

          <div id="topicsCountWrap" style="display:none; margin-top:8px">
            <label for="topicsCount">S·ªë l∆∞·ª£ng ƒë·ªÅ t√†i</label>
            <input id="topicsCount" type="number" min="1" value="5" aria-label="S·ªë l∆∞·ª£ng ƒë·ªÅ t√†i">
            <div class="hint">S·∫Ω sinh "ƒê·ªÅ t√†i 1" ‚Ä¶ "ƒê·ªÅ t√†i N".</div>
          </div>

          <div class="row" style="margin-top:10px">
            <label><input type="checkbox" id="allowDupChk"> Cho ph√©p l·∫∑p ch·ªß ƒë·ªÅ</label>
          </div>

          <div class="row" style="margin-top:10px">
            <div style="flex:1; min-width:200px">
              <label for="seedInput">Seed (t√πy ch·ªçn, ƒë·ªÉ t√°i l·∫≠p)</label>
              <input id="seedInput" type="text" placeholder="v√≠ d·ª•: anhngoc">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="assignBtn">Sinh c·∫∑p</button>
            <button class="btn" id="rerollBtn">X√°o l·∫°i</button>
            <button class="btn" id="resetAssignBtn">Reset</button>
          </div>
          <div id="assignWarn" class="hint" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div class="toolbar" style="justify-content:space-between; align-items:center; margin-bottom:8px">
            <h2 style="margin:0">K·∫øt qu·∫£ gh√©p (Nh√≥m ‚Äî Ch·ªß ƒë·ªÅ)</h2>
            <div class="toolbar">
              <button class="btn" id="copyAssignBtn">Copy</button>
              <button class="btn success" id="csvBtn">Export CSV</button>
              <button class="btn ghost" id="printBtn">In</button>
            </div>
          </div>
          <div style="overflow:auto; max-height:420px">
            <table id="assignTable">
              <thead><tr><th>Nh√≥m</th><th>Ch·ªß ƒë·ªÅ</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ======= Utilities =======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function toast(msg){
      // Minimal toast using alert replacement
      console.log(msg);
    }

    function clamp(n,min,max){return Math.min(Math.max(n,min),max)}

    // Secure random int [0, n)
    function cryptoRandInt(n){
      if (n<=0) throw new Error('n must be > 0');
      const arr = new Uint32Array(1);
      let x; const limit = Math.floor(0xFFFFFFFF / n) * n; // avoid modulo bias
      do { crypto.getRandomValues(arr); x = arr[0]; } while (x >= limit);
      return x % n;
    }

    // Seeded PRNG (mulberry32) helpers
    function xmur3(str){
      let h = 1779033703 ^ str.length;
      for (let i=0;i<str.length;i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function(){
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
      }
    }
    function mulberry32(a){
      return function(){
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a>>>15, 1 | a);
        t ^= t + Math.imul(t ^ t>>>7, 61 | t);
        return ((t ^ t>>>14) >>> 0) / 4294967296;
      }
    }

    function makeRNG(seedStr){
      if (!seedStr) return { next: () => crypto.getRandomValues(new Uint32Array(1))[0] / 2**32 };
      const seed = xmur3(seedStr)();
      const rnd = mulberry32(seed);
      return { next: () => rnd() };
    }

    function shuffle(arr, rng){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor((rng?.next?.() ?? Math.random()) * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Download CSV helper
    function downloadText(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // ======= Tabs =======
    (function(){
      const tabWheel = $('#tab-wheel');
      const tabAssign = $('#tab-assign');
      const panelWheel = $('#panel-wheel');
      const panelAssign = $('#panel-assign');
      function activate(tab){
        const isWheel = tab.id === 'tab-wheel';
        tabWheel.setAttribute('aria-selected', isWheel);
        tabAssign.setAttribute('aria-selected', !isWheel);
        panelWheel.hidden = !isWheel; panelAssign.hidden = isWheel;
      }
      tabWheel.addEventListener('click', ()=>activate(tabWheel));
      tabAssign.addEventListener('click', ()=>activate(tabAssign));
    })();

    // ======= Wheel of Numbers =======
    const wheelState = {
      numbers: [],
      rotation: 0, // degrees
      spinning: false,
      rng: makeRNG(),
    };

    const wheelSvg = $('#wheelSvg');
    const historyList = $('#historyList');
    const lastResultEl = $('#lastResult');

    function buildWheelFromInputs(){
      const start = parseInt($('#startNum').value, 10);
      const end = parseInt($('#endNum').value, 10);
      const hint = $('#wheelHint');
      if (Number.isNaN(start)||Number.isNaN(end)) { hint.textContent = 'Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá.'; return; }
      if (start >= end){ hint.innerHTML = '<span class="warn">start ph·∫£i nh·ªè h∆°n end</span>'; return; }
      const count = end - start + 1;
      if (count > 1000){ hint.innerHTML = '<span class="warn">Qu√° nhi·ªÅu ph·∫ßn t·ª≠ (>1000) c√≥ th·ªÉ l√†m ch·∫≠m.</span>'; }
      else if (count > 200){ hint.textContent = 'L∆∞u √Ω: nhi·ªÅu √¥, ch·ªØ c√≥ th·ªÉ nh·ªè.'; }
      else hint.textContent = '';
      wheelState.numbers = Array.from({length: count}, (_,i)=> start + i);
      wheelState.rotation = 0;
      renderWheel();
      lastResultEl.textContent = '‚Äì';
    }

    function renderWheel(){
      const cx=250, cy=250, r=220;
      const n = wheelState.numbers.length;
      wheelSvg.innerHTML = '';

      // Draw outer circle bg
      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); circle.setAttribute('r', r+6);
      circle.setAttribute('fill', '#0000'); circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--border'));
      circle.setAttribute('stroke-width', '2');
      wheelSvg.appendChild(circle);

      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('id','wheelGroup');
      g.setAttribute('transform', `rotate(${wheelState.rotation} ${cx} ${cy})`);
      wheelSvg.appendChild(g);

      if (n === 0){
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', cx); text.setAttribute('y', cy);
        text.setAttribute('text-anchor','middle'); text.setAttribute('dominant-baseline','middle');
        text.setAttribute('fill', 'var(--muted)');
        text.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
        wheelSvg.appendChild(text);
        return;
      }

      const sectorAngle = 2 * Math.PI / n;
      const palette = [ '#4361ee', '#4cc9f0', '#3a86ff', '#ffbe0b', '#fb5607', '#ff006e', '#8338ec', '#06d6a0' ];

      for (let i=0;i<n;i++){
        const a1 = i * sectorAngle - Math.PI/2; // start angle (top at -90deg)
        const a2 = (i+1) * sectorAngle - Math.PI/2; // end angle
        const x1 = cx + r * Math.cos(a1), y1 = cy + r * Math.sin(a1);
        const x2 = cx + r * Math.cos(a2), y2 = cy + r * Math.sin(a2);
        const largeArc = (a2 - a1) > Math.PI ? 1 : 0;

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        const d = [
          `M ${cx} ${cy}`,
          `L ${x1} ${y1}`,
          `A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`,
          'Z'
        ].join(' ');
        path.setAttribute('d', d);
        path.setAttribute('fill', palette[i % palette.length]);
        path.setAttribute('fill-opacity','0.9');
        path.setAttribute('stroke', 'rgba(0,0,0,0.15)');
        g.appendChild(path);

        // label
        const mid = (a1 + a2) / 2;
        const rx = cx + (r * 0.65) * Math.cos(mid);
        const ry = cy + (r * 0.65) * Math.sin(mid);
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', rx); text.setAttribute('y', ry);
        text.setAttribute('text-anchor','middle'); text.setAttribute('dominant-baseline','middle');
        text.setAttribute('fill', 'white');
        const fontSize = n > 40 ? 9 : n > 24 ? 12 : 14;
        text.setAttribute('font-size', fontSize);
        // Keep label upright: rotate back opposite of wheel wedge orientation
        const deg = (mid + Math.PI/2) * 180/Math.PI; // convert to deg from vertical baseline
        text.setAttribute('transform', `rotate(${ -deg } ${rx} ${ry})`);
        text.textContent = String(wheelState.numbers[i]);
        g.appendChild(text);
      }

      // Draw center cap
      const cap = document.createElementNS('http://www.w3.org/2000/svg','circle');
      cap.setAttribute('cx', cx); cap.setAttribute('cy', cy); cap.setAttribute('r', 14);
      cap.setAttribute('fill', 'var(--bg)'); cap.setAttribute('stroke','var(--accent)'); cap.setAttribute('stroke-width','3');
      g.appendChild(cap);
    }

    function setWheelRotation(deg){
      const g = $('#wheelGroup');
      if (!g) return;
      g.setAttribute('transform', `rotate(${deg} 250 250)`);
    }

    function selectIndexFromRotation(rotationDeg){
      const n = wheelState.numbers.length;
      if (n === 0) return -1;
      const per = 360 / n;
      let norm = (360 - (rotationDeg % 360));
      if (norm < 0) norm += 360;
      const idx = Math.floor(norm / per) % n;
      return idx;
    }

    function spin(){
      if (wheelState.spinning) return;
      if (wheelState.numbers.length === 0){ toast('Ch∆∞a t·∫°o v√≤ng.'); return; }
      if (wheelState.numbers.length === 1 && $('#noRepeatChk').checked){
        // Will remove last; but allow this turn
      }
      wheelState.spinning = true;
      $('#spinBtn').disabled = true; $('#buildWheelBtn').disabled = true; $('#resetWheelBtn').disabled = true;

      const n = wheelState.numbers.length;
      // Choose target index uniformly
      const targetIdx = cryptoRandInt(n);
      const per = 360 / n;
      const targetCenter = targetIdx * per + per/2; // in normalized space (pointer at 0¬∞)
      // rotation needed: normAngle == targetCenter => rotation = 360k + (360 - targetCenter)
      const k = 5 + cryptoRandInt(3); // 5..7 extra spins
      const jitter = (Math.random() - 0.5) * (per * 0.6); // stay well inside sector
      const finalRotation = 360 * k + (360 - (targetCenter + jitter));
      const startRotation = wheelState.rotation;
      const delta = finalRotation;
      const duration = 2500 + cryptoRandInt(2000); // 2.5s - 4.5s

      const startTime = performance.now();
      const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

      function frame(now){
        const t = clamp((now - startTime) / duration, 0, 1);
        const eased = easeOutCubic(t);
        const current = startRotation + delta * eased;
        wheelState.rotation = current;
        setWheelRotation(current);
        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          wheelState.spinning = false;
          $('#spinBtn').disabled = false; $('#buildWheelBtn').disabled = false; $('#resetWheelBtn').disabled = false;
          const idx = selectIndexFromRotation(current);
          const value = wheelState.numbers[idx];
          showWheelResult(value);
          if ($('#noRepeatChk').checked){
            wheelState.numbers.splice(idx,1);
            // Keep rotation aligned with new array positions: we keep visual rotation, but rebuild segments
          }
          renderWheel();
        }
      }
      requestAnimationFrame(frame);
    }

    function showWheelResult(value){
      lastResultEl.textContent = value;
      lastResultEl.animate([
        { transform:'scale(0.9)', opacity:0 },
        { transform:'scale(1.05)', opacity:1, offset:0.7 },
        { transform:'scale(1)', opacity:1 }
      ], { duration:450, easing:'cubic-bezier(.2,.8,.2,1)' });

      const li = document.createElement('li');
      const ts = new Date().toLocaleTimeString();
      li.textContent = `${ts}: ${value}`;
      historyList.prepend(li);
      if (historyList.children.length > 100) historyList.removeChild(historyList.lastChild);
    }

    async function copyLast(){
      const t = lastResultEl.textContent;
      if (!t || t==='‚Äì') return;
      try{ await navigator.clipboard.writeText(t); toast('ƒê√£ copy k·∫øt qu·∫£'); }catch{ toast('Kh√¥ng copy ƒë∆∞·ª£c'); }
    }

    function resetWheel(){
      wheelState.rotation = 0; wheelState.spinning = false; setWheelRotation(0);
      historyList.innerHTML = ''; lastResultEl.textContent = '‚Äì';
      buildWheelFromInputs();
    }

    // Bind wheel events
    $('#buildWheelBtn').addEventListener('click', buildWheelFromInputs);
    $('#spinBtn').addEventListener('click', spin);
    $('#copyLastBtn').addEventListener('click', copyLast);
    $('#resetWheelBtn').addEventListener('click', resetWheel);

    // Init wheel default
    buildWheelFromInputs();

    // ======= Assign Topics to Groups =======
    const assignState = { topics: [], lastAssignments: [], seed: '', rerollCounter: 0 };

    // Toggle topic mode
    $$('input[name="topicMode"]').forEach(r => r.addEventListener('change', () => {
      const mode = $('input[name="topicMode"]:checked').value;
      $('#topicsTextareaWrap').style.display = mode === 'textarea' ? '' : 'none';
      $('#topicsCountWrap').style.display = mode === 'count' ? '' : 'none';
    }));

    function parseTopicsFromTextarea(text){
      const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      // dedup preserving order
      const seen = new Set();
      const out = [];
      for (const s of lines){ if (!seen.has(s)){ seen.add(s); out.push(s); } }
      return out;
    }

    function generateTopicsByCount(n){
      n = Math.max(1, Math.floor(n));
      return Array.from({length:n}, (_,i)=>`ƒê·ªÅ t√†i ${i+1}`);
    }

    function getTopicsInput(){
      const mode = $('input[name="topicMode"]:checked').value;
      if (mode === 'textarea'){
        return parseTopicsFromTextarea($('#topicsTextarea').value);
      } else {
        const n = parseInt($('#topicsCount').value, 10);
        if (!Number.isFinite(n) || n < 1) return [];
        return generateTopicsByCount(n);
      }
    }

    function validateAssign(gCount, topics, allowDup){
      if (!Number.isFinite(gCount) || gCount < 1) return {ok:false, msg:'S·ªë nh√≥m ph·∫£i ‚â• 1'};
      if (!topics.length) return {ok:false, msg:'Danh s√°ch ch·ªß ƒë·ªÅ tr·ªëng'};
      if (!allowDup && gCount > topics.length) return {ok:false, msg:'S·ªë nh√≥m > s·ªë ch·ªß ƒë·ªÅ. B·∫≠t "Cho ph√©p l·∫∑p" ho·∫∑c th√™m ch·ªß ƒë·ªÅ.'};
      if (gCount > 1000) return {ok:false, msg:'Qu√° nhi·ªÅu nh√≥m (>1000)'};
      if (topics.length > 2000) return {ok:false, msg:'Qu√° nhi·ªÅu ch·ªß ƒë·ªÅ (>2000)'};
      return {ok:true};
    }

    function assignTopics(gCount, topics, allowDup, rng){
      const res = [];
      if (allowDup){
        for (let i=0;i<gCount;i++){
          const idx = Math.floor(rng.next() * topics.length);
          res.push({ group: i+1, topic: topics[idx] });
        }
      } else {
        const order = shuffle(topics.map((_,i)=>i), rng);
        for (let i=0;i<gCount;i++){
          res.push({ group: i+1, topic: topics[order[i]] });
        }
      }
      return res;
    }

    function renderAssignments(rows){
      const tbody = $('#assignTable tbody');
      tbody.innerHTML = '';
      for (const {group, topic} of rows){
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = `Group ${group}`;
        const td2 = document.createElement('td'); td2.textContent = topic; td2.title = topic;
        tr.append(td1, td2); tbody.appendChild(tr);
      }
    }

    function copyAssignments(){
      const lines = assignState.lastAssignments.map(r=>`Group ${r.group} - ${r.topic}`).join('\n');
      if (!lines) return;
      navigator.clipboard.writeText(lines).then(()=>toast('ƒê√£ copy danh s√°ch')).catch(()=>toast('Copy th·∫•t b·∫°i'));
    }

    function exportCSV(){
      const rows = assignState.lastAssignments;
      if (!rows.length) return;
      const csv = ['Group,Topic', ...rows.map(r => `"Group ${r.group}","${r.topic.replace(/"/g,'""')}"`)].join('\n');
      downloadText('assignments.csv', csv);
    }

    function doAssign(isReroll=false){
      const g = parseInt($('#groupCount').value, 10);
      const topics = getTopicsInput();
      const allowDup = $('#allowDupChk').checked;
      const seedStr = $('#seedInput').value.trim();
      const v = validateAssign(g, topics, allowDup);
      const warn = $('#assignWarn');
      if (!v.ok){ warn.innerHTML = `<span class="warn">${v.msg}</span>`; return; } else warn.textContent = '';

      let rng;
      if (seedStr){
        // For reroll: combine seed with counter to get different but reproducible sequences
        if (isReroll) assignState.rerollCounter++; else assignState.rerollCounter = 0;
        rng = makeRNG(seedStr + '::' + assignState.rerollCounter);
      } else {
        rng = makeRNG();
      }

      const rows = assignTopics(g, topics, allowDup, rng);
      assignState.topics = topics;
      assignState.lastAssignments = rows;
      assignState.seed = seedStr;
      renderAssignments(rows);
    }

    // Bind assign events
    $('#assignBtn').addEventListener('click', ()=>doAssign(false));
    $('#rerollBtn').addEventListener('click', ()=>doAssign(true));
    $('#resetAssignBtn').addEventListener('click', ()=>{
      $('#groupCount').value = 5;
      $('#topicsTextarea').value = '';
      $('#topicsCount').value = 5;
      $('#allowDupChk').checked = false;
      $('#seedInput').value = '';
      assignState.lastAssignments = [];
      renderAssignments([]);
      $('#assignWarn').textContent = '';
    });
    $('#copyAssignBtn').addEventListener('click', copyAssignments);
    $('#csvBtn').addEventListener('click', exportCSV);
    $('#printBtn').addEventListener('click', ()=>window.print());

    // Provide a small starter list for convenience
    $('#topicsTextarea').value = [
      'Hi Hi',
      'He He',
      'Hu Hu',
      'Ha Ha',
      'Ha Ha Hu Hu Hi Hi He He'
    ].join('\n');

    // Keyboard: press Enter to trigger primary action within panels
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        const wheelVisible = !$('#panel-wheel').hidden;
        if (wheelVisible) {
          // If focus is in start/end inputs, treat as "T·∫°o v√≤ng"; else, Start spin
          const active = document.activeElement;
          if (active && (active.id==='startNum' || active.id==='endNum')) $('#buildWheelBtn').click();
          else $('#spinBtn').click();
        } else {
          $('#assignBtn').click();
        }
      }
    });
  </script>
</body>
</html>
