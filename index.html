<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V√≤ng quay s·ªë & Chia ch·ªß ƒë·ªÅ (offline) ‚Äî Pink Hearts Edition</title>
  <style>
    :root{
      --bg: #ffd5e5; /* n·ªÅn h·ªìng nh·∫°t */
      --bg-elev: #fff0f6;
      --text: #141414;
      --muted: #6b7280;
      --accent: #ff4d8d; /* h·ªìng ƒë·∫≠m */
      --accent-2: #22c55e;
      --danger: #ef4444;
      --border: #f2c2d4;
      --ring: #ff4d8d55;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; position:relative; overflow-x:hidden}

    /* Hearts background */
    .heart{position:fixed; width:18px; height:18px; background:white; transform:rotate(45deg); opacity:.85; filter:drop-shadow(0 2px 2px rgba(0,0,0,.08)); z-index:0}
    .heart:before,.heart:after{content:""; position:absolute; width:18px; height:18px; background:white; border-radius:50%}
    .heart:before{top:-9px; left:0}
    .heart:after{left:-9px; top:0}
    @keyframes floatUp { 0%{ transform:translateY(100vh) rotate(45deg); opacity:.9 } 100%{ transform:translateY(-15vh) rotate(45deg); opacity:0 } }

    .container{max-width:1100px;margin:0 auto;padding:24px; position:relative; z-index:1}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{background:var(--bg-elev);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab-btn[aria-selected="true"]{outline:2px solid var(--ring); background:linear-gradient(180deg,var(--bg-elev),#ffe3ef); box-shadow:0 1px 0 #00000010 inset}
    .grid{display:grid;gap:16px}
    .two-col{grid-template-columns:1.1fr 1fr}
    @media (max-width:900px){.two-col{grid-template-columns:1fr}}
    .card{background:var(--bg-elev);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="number"],input[type="text"],textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text)}
    textarea{min-height:140px;resize:vertical}
    .btn{appearance:none;border:1px solid var(--border);background:#ffe6ef;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:white}
    .btn.ghost{background:transparent}
    .btn.success{background:var(--accent-2);color:white;border-color:transparent}
    .btn.danger{background:var(--danger);color:white;border-color:transparent}
    .btn:focus{outline:3px solid var(--ring)}
    .hint{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .result-banner{font-size:48px;font-weight:800;text-align:center;margin:0}
    .history{max-height:180px;overflow:auto;border:1px dashed var(--border);border-radius:12px;padding:8px;background:#fff}
    .warn{color:var(--danger); font-weight:600}

    /* Wheel */
    .wheel-wrap{position:relative;display:grid;place-items:center;aspect-ratio:1/1;width:min(520px, 90vw);margin:0 auto}
    .pointer{position:absolute;top:-10px;left:50%;transform:translateX(-50%); width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid var(--accent)}
    .wheel-svg{width:100%;height:100%}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;background:#fff}
    th{position:sticky;top:0;background:#ffe3ef;z-index:1}
    .sticky-tools{position:sticky;top:8px;z-index:3}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üé° V√≤ng quay KhongMayMan:( üíñ</h1>
      <nav class="tabs" role="tablist" aria-label="Ch·ªçn ch·ª©c nƒÉng">
        <button class="tab-btn" role="tab" id="tab-wheel" aria-selected="true" aria-controls="panel-wheel">V√≤ng quay s·ªë</button>
        <button class="tab-btn" role="tab" id="tab-assign" aria-selected="false" aria-controls="panel-assign">Chia ch·ªß ƒë·ªÅ cho nh√≥m</button>
      </nav>
    </header>

    <!-- Panel: Wheel -->
    <section id="panel-wheel" role="tabpanel" aria-labelledby="tab-wheel">
      <div class="grid two-col">
        <div class="card" aria-labelledby="wheel-title">
          <h2 id="wheel-title" style="margin-top:0">Thi·∫øt l·∫≠p v√≤ng quay</h2>
          <div class="row">
            <div style="flex:1; min-width:140px">
              <label for="startNum">S·ªë b·∫Øt ƒë·∫ßu</label>
              <input id="startNum" type="number" inputmode="numeric" value="1" aria-label="S·ªë b·∫Øt ƒë·∫ßu" />
            </div>
            <div style="flex:1; min-width:140px">
              <label for="endNum">S·ªë k·∫øt th√∫c</label>
              <input id="endNum" type="number" inputmode="numeric" value="12" aria-label="S·ªë k·∫øt th√∫c" />
            </div>
            <div>
              <button class="btn" id="buildWheelBtn" aria-label="T·∫°o v√≤ng">T·∫°o v√≤ng</button>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <label class="hint"><input type="checkbox" id="noRepeatChk"> Kh√¥ng l·∫∑p (lo·∫°i s·ªë ƒë√£ tr√∫ng ·ªü l∆∞·ª£t sau)</label>
            <span class="hint" id="wheelHint"></span>
          </div>
          <div class="wheel-wrap" aria-live="polite">
            <div class="pointer" aria-hidden="true"></div>
            <svg class="wheel-svg" id="wheelSvg" viewBox="0 0 500 500" role="img" aria-label="V√≤ng quay s·ªë">
              <!-- dynamic -->
            </svg>
          </div>
          <div class="row" style="justify-content:center; margin-top:12px">
            <button class="btn primary" id="spinBtn" aria-label="B·∫Øt ƒë·∫ßu quay">Start</button>
            <button class="btn ghost" id="copyLastBtn" aria-label="Copy k·∫øt qu·∫£ g·∫ßn nh·∫•t">Copy k·∫øt qu·∫£</button>
            <button class="btn" id="resetWheelBtn" aria-label="Reset v√≤ng quay">Reset</button>
          </div>
        </div>
        <div class="card">
          <div class="sticky-tools">
            <h2 style="margin:0 0 8px">K·∫øt qu·∫£</h2>
          </div>
          <p id="lastResult" class="result-banner" aria-live="polite">‚Äì</p>
          <h3 style="margin:16px 0 8px">L·ªãch s·ª≠</h3>
          <ol id="historyList" class="history" aria-live="polite"></ol>
        </div>
      </div>
    </section>

    <!-- Panel: Assign topics -->
    <section id="panel-assign" role="tabpanel" aria-labelledby="tab-assign" hidden>
      <div class="grid two-col">
        <div class="card">
          <h2 style="margin-top:0">Thi·∫øt l·∫≠p chia ch·ªß ƒë·ªÅ</h2>
          <div class="row">
            <div style="flex:1; min-width:160px">
              <label for="groupCount">S·ªë nh√≥m</label>
              <input id="groupCount" type="number" min="1" value="5" aria-label="S·ªë nh√≥m">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <label><input type="radio" name="topicMode" value="textarea" checked> Nh·∫≠p danh s√°ch ch·ªß ƒë·ªÅ (m·ªói d√≤ng m·ªôt ch·ªß ƒë·ªÅ)</label>
            <label><input type="radio" name="topicMode" value="count"> Nh·∫≠p s·ªë l∆∞·ª£ng ƒë·ªÅ t√†i</label>
          </div>

          <div id="topicsTextareaWrap" style="margin-top:8px">
            <label for="topicsTextarea">Danh s√°ch ch·ªß ƒë·ªÅ</label>
            <textarea id="topicsTextarea" placeholder="m·ªói ƒë·ªÅ t√†i n·∫±m tr√™n m·ªôt d√≤ng"></textarea>
            <div class="hint">D√≤ng r·ªóng s·∫Ω b·ªã b·ªè qua. Ch·ªß ƒë·ªÅ tr√πng s·∫Ω t·ª± lo·∫°i tr·ª´ (tr√°nh nh·∫≠p l·ªói).</div>
          </div>

          <div id="topicsCountWrap" style="display:none; margin-top:8px">
            <label for="topicsCount">S·ªë l∆∞·ª£ng ƒë·ªÅ t√†i</label>
            <input id="topicsCount" type="number" min="1" value="5" aria-label="S·ªë l∆∞·ª£ng ƒë·ªÅ t√†i">
            <div class="hint">S·∫Ω sinh "ƒê·ªÅ t√†i 1" ‚Ä¶ "ƒê·ªÅ t√†i N".</div>
          </div>

          <div class="row" style="margin-top:10px">
            <label><input type="checkbox" id="allowDupChk"> Cho ph√©p l·∫∑p ch·ªß ƒë·ªÅ</label>
            <span class="hint">N·∫øu t·∫Øt, y√™u c·∫ßu s·ªë ch·ªß ƒë·ªÅ ‚â• s·ªë nh√≥m.</span>
          </div>

          <div class="row" style="margin-top:10px">
            <div style="flex:1; min-width:200px">
              <label for="seedInput">Seed (t√πy ch·ªçn, ƒë·ªÉ t√°i l·∫≠p)</label>
              <input id="seedInput" type="text" placeholder="v√≠ d·ª•: semester-2025">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="assignBtn">Sinh c·∫∑p</button>
            <button class="btn" id="rerollBtn">X√°o l·∫°i</button>
            <button class="btn" id="resetAssignBtn">Reset</button>
          </div>
          <div id="assignWarn" class="hint" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div class="toolbar" style="justify-content:space-between; align-items:center; margin-bottom:8px">
            <h2 style="margin:0">K·∫øt qu·∫£ gh√©p (Nh√≥m ‚Äî Ch·ªß ƒë·ªÅ)</h2>
            <div class="toolbar">
              <button class="btn" id="copyAssignBtn">Copy</button>
              <button class="btn success" id="csvBtn">Export CSV</button>
              <button class="btn ghost" id="printBtn">In</button>
            </div>
          </div>
          <div style="overflow:auto; max-height:420px">
            <table id="assignTable">
              <thead><tr><th>Nh√≥m</th><th>Ch·ªß ƒë·ªÅ</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // === Hearts background ===
    function spawnHeart(){
      const h = document.createElement('div');
      h.className = 'heart';
      const size = 14 + Math.random()*14; // 14‚Äì28px
      h.style.width = size + 'px'; h.style.height = size + 'px';
      h.style.left = (Math.random()*100) + 'vw';
      const dur = 6 + Math.random()*6; // 6‚Äì12s
      h.style.animation = `floatUp ${dur}s linear forwards`;
      document.body.appendChild(h);
      setTimeout(()=>h.remove(), dur*1000 + 500);
    }
    // burst at start
    for(let i=0;i<20;i++) setTimeout(spawnHeart, i*120);
    // continuous spawn
    setInterval(spawnHeart, 600);

    // ======= Utilities =======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp=(n,min,max)=>Math.min(Math.max(n,min),max);
    function toast(msg){ console.log(msg); }

    function cryptoRandInt(n){
      if (n<=0) throw new Error('n must be > 0');
      const arr = new Uint32Array(1);
      let x; const limit = Math.floor(0xFFFFFFFF / n) * n;
      do { crypto.getRandomValues(arr); x = arr[0]; } while (x >= limit);
      return x % n;
    }
    function xmur3(str){ let h = 1779033703 ^ str.length; for (let i=0;i<str.length;i++){ h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = (h << 13) | (h >>> 19); } return function(){ h = Math.imul(h ^ (h >>> 16), 2246822507); h = Math.imul(h ^ (h >>> 13), 3266489909); return (h ^= h >>> 16) >>> 0; } }
    function mulberry32(a){ return function(){ a|=0; a = a + 0x6D2B79F5 | 0; let t = Math.imul(a ^ a>>>15, 1 | a); t ^= t + Math.imul(t ^ t>>>7, 61 | t); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
    function makeRNG(seedStr){ if (!seedStr) return { next: () => crypto.getRandomValues(new Uint32Array(1))[0] / 2**32 }; const seed = xmur3(seedStr)(); const rnd = mulberry32(seed); return { next: () => rnd() }; }
    function shuffle(arr, rng){ const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j = Math.floor((rng?.next?.() ?? Math.random()) * (i+1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
    function downloadText(filename, text){ const blob = new Blob([text], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }

    // ======= Tabs =======
    (function(){
      const tabWheel = $('#tab-wheel');
      const tabAssign = $('#tab-assign');
      const panelWheel = $('#panel-wheel');
      const panelAssign = $('#panel-assign');
      function activate(tab){
        const isWheel = tab.id === 'tab-wheel';
        tabWheel.setAttribute('aria-selected', isWheel);
        tabAssign.setAttribute('aria-selected', !isWheel);
        panelWheel.hidden = !isWheel; panelAssign.hidden = isWheel;
      }
      tabWheel.addEventListener('click', ()=>activate(tabWheel));
      tabAssign.addEventListener('click', ()=>activate(tabAssign));
    })();

    // ======= Wheel of Numbers =======
    const wheelState = { numbers: [], rotation: 0, spinning: false };
    const wheelSvg = $('#wheelSvg');
    const historyList = $('#historyList');
    const lastResultEl = $('#lastResult');

    function buildWheelFromInputs(){
      const start = parseInt($('#startNum').value, 10);
      const end = parseInt($('#endNum').value, 10);
      const hint = $('#wheelHint');
      if (Number.isNaN(start)||Number.isNaN(end)) { hint.textContent = 'Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá.'; return; }
      if (start >= end){ hint.innerHTML = '<span class="warn">start ph·∫£i nh·ªè h∆°n end</span>'; return; }
      const count = end - start + 1;
      if (count > 1000){ hint.innerHTML = '<span class="warn">Qu√° nhi·ªÅu ph·∫ßn t·ª≠ (>1000) c√≥ th·ªÉ l√†m ch·∫≠m.</span>'; }
      else if (count > 200){ hint.textContent = 'L∆∞u √Ω: nhi·ªÅu √¥, ch·ªØ c√≥ th·ªÉ nh·ªè.'; }
      else hint.textContent = '';
      wheelState.numbers = Array.from({length: count}, (_,i)=> start + i);
      wheelState.rotation = 0;
      renderWheel();
      lastResultEl.textContent = '‚Äì';
    }

    function renderWheel(){
      const cx=250, cy=250, r=220;
      const n = wheelState.numbers.length;
      wheelSvg.innerHTML = '';

      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx', cx); circle.setAttribute('cy', cy); circle.setAttribute('r', r+6);
      circle.setAttribute('fill', '#0000'); circle.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--border'));
      circle.setAttribute('stroke-width', '2');
      wheelSvg.appendChild(circle);

      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('id','wheelGroup');
      g.setAttribute('transform', `rotate(${wheelState.rotation} ${cx} ${cy})`);
      wheelSvg.appendChild(g);

      if (n === 0){
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', cx); text.setAttribute('y', cy);
        text.setAttribute('text-anchor','middle'); text.setAttribute('dominant-baseline','middle');
        text.setAttribute('fill', 'var(--muted)');
        text.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu';
        wheelSvg.appendChild(text);
        return;
      }

      const sectorAngle = 2 * Math.PI / n;
      const palette = [ '#ff6ea9', '#ff9ec5', '#ffc1d9', '#ffd6e7', '#ff9fb7', '#ff6ea9', '#ff87b7', '#ffb3cf' ];

      for (let i=0;i<n;i++){
        const a1 = i * sectorAngle - Math.PI/2;
        const a2 = (i+1) * sectorAngle - Math.PI/2;
        const x1 = cx + r * Math.cos(a1), y1 = cy + r * Math.sin(a1);
        const x2 = cx + r * Math.cos(a2), y2 = cy + r * Math.sin(a2);
        const largeArc = (a2 - a1) > Math.PI ? 1 : 0;

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        const d = [`M ${cx} ${cy}`, `L ${x1} ${y1}`, `A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`, 'Z'].join(' ');
        path.setAttribute('d', d);
        path.setAttribute('fill', palette[i % palette.length]);
        path.setAttribute('fill-opacity','0.95');
        path.setAttribute('stroke', 'rgba(255,255,255,0.6)');
        g.appendChild(path);

        const mid = (a1 + a2) / 2;
        const rx = cx + (r * 0.65) * Math.cos(mid);
        const ry = cy + (r * 0.65) * Math.sin(mid);
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', rx); text.setAttribute('y', ry);
        text.setAttribute('text-anchor','middle'); text.setAttribute('dominant-baseline','middle');
        text.setAttribute('fill', '#401020');
        const fontSize = n > 40 ? 9 : n > 24 ? 12 : 14;
        text.setAttribute('font-size', fontSize);
        const deg = (mid + Math.PI/2) * 180/Math.PI;
        text.setAttribute('transform', `rotate(${-deg} ${rx} ${ry})`);
        text.textContent = String(wheelState.numbers[i]);
        g.appendChild(text);
      }
      const cap = document.createElementNS('http://www.w3.org/2000/svg','circle');
      cap.setAttribute('cx', cx); cap.setAttribute('cy', cy); cap.setAttribute('r', 14);
      cap.setAttribute('fill', '#fff'); cap.setAttribute('stroke','var(--accent)'); cap.setAttribute('stroke-width','3');
      g.appendChild(cap);
    }

    function setWheelRotation(deg){ const g = document.getElementById('wheelGroup'); if (!g) return; g.setAttribute('transform', `rotate(${deg} 250 250)`); }
    function selectIndexFromRotation(rotationDeg){ const n = wheelState.numbers.length; if (n === 0) return -1; const per = 360 / n; let norm = (360 - (rotationDeg % 360)); if (norm < 0) norm += 360; const idx = Math.floor(norm / per) % n; return idx; }

    function spin(){
      if (wheelState.spinning) return;
      if (wheelState.numbers.length === 0){ toast('Ch∆∞a t·∫°o v√≤ng.'); return; }
      wheelState.spinning = true;
      document.getElementById('spinBtn').disabled = true; document.getElementById('buildWheelBtn').disabled = true; document.getElementById('resetWheelBtn').disabled = true;

      const n = wheelState.numbers.length;
      const targetIdx = cryptoRandInt(n);
      const per = 360 / n;
      const targetCenter = targetIdx * per + per/2;
      const k = 5 + cryptoRandInt(3);
      const jitter = (Math.random() - 0.5) * (per * 0.6);
      const finalRotation = 360 * k + (360 - (targetCenter + jitter));
      const startRotation = wheelState.rotation;
      const delta = finalRotation;
      const duration = 2500 + cryptoRandInt(2000);

      const startTime = performance.now();
      const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

      function frame(now){
        const t = clamp((now - startTime) / duration, 0, 1);
        const eased = easeOutCubic(t);
        const current = startRotation + delta * eased;
        wheelState.rotation = current; setWheelRotation(current);
        if (t < 1) requestAnimationFrame(frame); else {
          wheelState.spinning = false;
          document.getElementById('spinBtn').disabled = false; document.getElementById('buildWheelBtn').disabled = false; document.getElementById('resetWheelBtn').disabled = false;
          const idx = selectIndexFromRotation(current);
          const value = wheelState.numbers[idx];
          showWheelResult(value);
          if (document.getElementById('noRepeatChk').checked){ wheelState.numbers.splice(idx,1); }
          renderWheel();
        }
      }
      requestAnimationFrame(frame);
    }

    function showWheelResult(value){
      lastResultEl.textContent = value;
      lastResultEl.animate([{ transform:'scale(0.9)', opacity:0 }, { transform:'scale(1.05)', opacity:1, offset:0.7 }, { transform:'scale(1)', opacity:1 }], { duration:450, easing:'cubic-bezier(.2,.8,.2,1)' });
      const li = document.createElement('li'); const ts = new Date().toLocaleTimeString(); li.textContent = `${ts}: ${value}`; historyList.prepend(li); if (historyList.children.length > 100) historyList.removeChild(historyList.lastChild);
    }
    async function copyLast(){ const t = lastResultEl.textContent; if (!t || t==='‚Äì') return; try{ await navigator.clipboard.writeText(t); toast('ƒê√£ copy k·∫øt qu·∫£'); }catch{ toast('Kh√¥ng copy ƒë∆∞·ª£c'); }}
    function resetWheel(){ wheelState.rotation = 0; wheelState.spinning = false; setWheelRotation(0); historyList.innerHTML = ''; lastResultEl.textContent = '‚Äì'; buildWheelFromInputs(); }

    document.getElementById('buildWheelBtn').addEventListener('click', buildWheelFromInputs);
    document.getElementById('spinBtn').addEventListener('click', spin);
    document.getElementById('copyLastBtn').addEventListener('click', copyLast);
    document.getElementById('resetWheelBtn').addEventListener('click', resetWheel);
    buildWheelFromInputs();

    // ======= Assign Topics to Groups =======
    const assignState = { topics: [], lastAssignments: [], seed: '', rerollCounter: 0 };
    $$('input[name="topicMode"]').forEach(r => r.addEventListener('change', () => {
      const mode = $('input[name="topicMode"]:checked').value;
      document.getElementById('topicsTextareaWrap').style.display = mode === 'textarea' ? '' : 'none';
      document.getElementById('topicsCountWrap').style.display = mode === 'count' ? '' : 'none';
    }));

    function parseTopicsFromTextarea(text){ const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const seen=new Set(); const out=[]; for(const s of lines){ if(!seen.has(s)){ seen.add(s); out.push(s);} } return out; }
    function generateTopicsByCount(n){ n = Math.max(1, Math.floor(n)); return Array.from({length:n}, (_,i)=>`ƒê·ªÅ t√†i ${i+1}`); }
    function getTopicsInput(){ const mode = $('input[name="topicMode"]:checked').value; if (mode === 'textarea'){ return parseTopicsFromTextarea(document.getElementById('topicsTextarea').value); } else { const n = parseInt(document.getElementById('topicsCount').value, 10); if (!Number.isFinite(n) || n < 1) return []; return generateTopicsByCount(n); } }
    function validateAssign(gCount, topics, allowDup){ if (!Number.isFinite(gCount) || gCount < 1) return {ok:false, msg:'S·ªë nh√≥m ph·∫£i ‚â• 1'}; if (!topics.length) return {ok:false, msg:'Danh s√°ch ch·ªß ƒë·ªÅ tr·ªëng'}; if (!allowDup && gCount > topics.length) return {ok:false, msg:'S·ªë nh√≥m > s·ªë ch·ªß ƒë·ªÅ. B·∫≠t "Cho ph√©p l·∫∑p" ho·∫∑c th√™m ch·ªß ƒë·ªÅ.'}; if (gCount > 1000) return {ok:false, msg:'Qu√° nhi·ªÅu nh√≥m (>1000)'}; if (topics.length > 2000) return {ok:false, msg:'Qu√° nhi·ªÅu ch·ªß ƒë·ªÅ (>2000)'}; return {ok:true}; }
    function assignTopics(gCount, topics, allowDup, rng){ const res=[]; if (allowDup){ for (let i=0;i<gCount;i++){ const idx = Math.floor(rng.next() * topics.length); res.push({ group: i+1, topic: topics[idx] }); } } else { const order = shuffle(topics.map((_,i)=>i), rng); for (let i=0;i<gCount;i++){ res.push({ group: i+1, topic: topics[order[i]] }); } } return res; }
    function renderAssignments(rows){ const tbody = document.querySelector('#assignTable tbody'); tbody.innerHTML=''; for (const {group, topic} of rows){ const tr=document.createElement('tr'); const td1=document.createElement('td'); td1.textContent=`Group ${group}`; const td2=document.createElement('td'); td2.textContent=topic; td2.title=topic; tr.append(td1,td2); tbody.appendChild(tr);} }
    function copyAssignments(){ const lines = assignState.lastAssignments.map(r=>`Group ${r.group} - ${r.topic}`).join('\n'); if (!lines) return; navigator.clipboard.writeText(lines).then(()=>toast('ƒê√£ copy danh s√°ch')).catch(()=>toast('Copy th·∫•t b·∫°i')); }
    function exportCSV(){ const rows = assignState.lastAssignments; if (!rows.length) return; const csv = ['Group,Topic', ...rows.map(r => `"Group ${r.group}","${r.topic.replace(/"/g,'""')}"`)].join('\n'); downloadText('assignments.csv', csv); }
    function doAssign(isReroll=false){ const g = parseInt(document.getElementById('groupCount').value, 10); const topics = getTopicsInput(); const allowDup = document.getElementById('allowDupChk').checked; const seedStr = document.getElementById('seedInput').value.trim(); const v = validateAssign(g, topics, allowDup); const warn = document.getElementById('assignWarn'); if (!v.ok){ warn.innerHTML = `<span class="warn">${v.msg}</span>`; return; } else warn.textContent = ''; let rng; if (seedStr){ if (isReroll) assignState.rerollCounter++; else assignState.rerollCounter = 0; rng = makeRNG(seedStr + '::' + assignState.rerollCounter); } else { rng = makeRNG(); } const rows = assignTopics(g, topics, allowDup, rng); assignState.topics = topics; assignState.lastAssignments = rows; assignState.seed = seedStr; renderAssignments(rows); }

    document.getElementById('assignBtn').addEventListener('click', ()=>doAssign(false));
    document.getElementById('rerollBtn').addEventListener('click', ()=>doAssign(true));
    document.getElementById('resetAssignBtn').addEventListener('click', ()=>{ document.getElementById('groupCount').value = 5; document.getElementById('topicsTextarea').value = ''; document.getElementById('topicsCount').value = 5; document.getElementById('allowDupChk').checked = false; document.getElementById('seedInput').value = ''; assignState.lastAssignments = []; renderAssignments([]); document.getElementById('assignWarn').textContent = ''; });
    document.getElementById('copyAssignBtn').addEventListener('click', copyAssignments);
    document.getElementById('csvBtn').addEventListener('click', exportCSV);
    document.getElementById('printBtn').addEventListener('click', ()=>window.print());

    document.getElementById('topicsTextarea').value = [].join('\n');

    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        const wheelVisible = !document.getElementById('panel-wheel').hidden;
        if (wheelVisible) {
          const active = document.activeElement;
          if (active && (active.id==='startNum' || active.id==='endNum')) document.getElementById('buildWheelBtn').click();
          else document.getElementById('spinBtn').click();
        } else { document.getElementById('assignBtn').click(); }
      }
    });
  </script>
</body>
</html>
